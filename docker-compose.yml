# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CryptoAI Master â€” Docker Compose
# ì „ì²´ ì‹œìŠ¤í…œ í•œ ë²ˆì— ì‹¤í–‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸš€ ì‹¤í–‰:
#   docker-compose up -d
#
# ğŸ“‹ ë¡œê·¸:
#   docker-compose logs -f engine
#   docker-compose logs -f api
#
# ğŸ›‘ ì¢…ë£Œ:
#   docker-compose down
#
# ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”:
#   docker-compose down -v --rmi local
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

services:

  # â”€â”€â”€ ìë™ë§¤ë§¤ ì—”ì§„ (24ì‹œê°„ ë°±ê·¸ë¼ìš´ë“œ) â”€â”€â”€
  engine:
    build:
      context: ./engine
      dockerfile: Dockerfile
    container_name: crypto-engine
    restart: always
    env_file: ./shared/.env
    environment:
      - TRADING_MODE=paper
      - PYTHONUNBUFFERED=1
      - REDIS_URL=redis://redis:6379
      - PYTHONPATH=/app
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./engine:/app/engine # ê°œë°œ ì‹œ í•« ë¦¬ë¡œë“œ
      - engine-logs:/app/logs
    command: python -m engine.main
    networks:
      - crypto-net
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # â”€â”€â”€ FastAPI ë°±ì—”ë“œ â”€â”€â”€
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: crypto-api
    restart: always
    ports:
      - "8000:8000"
    env_file: ./shared/.env
    environment:
      - REDIS_URL=redis://redis:6379
      - PYTHONPATH=/app
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./api:/app # ê°œë°œ ì‹œ í•« ë¦¬ë¡œë“œ
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 15s
    networks:
      - crypto-net
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # â”€â”€â”€ Next.js ëŒ€ì‹œë³´ë“œ â”€â”€â”€
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      target: dev # ê°œë°œ ëª¨ë“œ (target: runner â†’ í”„ë¡œë•ì…˜)
    container_name: crypto-web
    restart: always
    ports:
      - "3000:3000"
    environment:
      - API_PROXY_BASE_URL=http://api:8000
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NEXT_PUBLIC_WS_URL=ws://localhost:8000
      - NODE_ENV=development
    depends_on:
      api:
        condition: service_healthy
    volumes:
      - ./web:/app # ê°œë°œ ì‹œ í•« ë¦¬ë¡œë“œ
      - /app/node_modules # node_modules ê²©ë¦¬
      - /app/.next # .next ìºì‹œ ê²©ë¦¬
    networks:
      - crypto-net
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # â”€â”€â”€ Redis (ìºì‹œ + Pub/Sub) â”€â”€â”€
  redis:
    image: redis:7-alpine
    container_name: crypto-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - crypto-net

# â”€â”€â”€ ë³¼ë¥¨ â”€â”€â”€
volumes:
  engine-logs:
    driver: local
  redis-data:
    driver: local

# â”€â”€â”€ ë„¤íŠ¸ì›Œí¬ â”€â”€â”€
networks:
  crypto-net:
    driver: bridge
